---
- name: Creating Ironic database
  command: docker exec -t kolla_toolbox /usr/bin/ansible localhost
    -m mysql_db
    -a "login_host='{{ database_address }}'
        login_port='{{ database_port }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ ironic_database_name }}'"
  register: ironic_database
  changed_when: "{{ ironic_database.stdout.find('localhost | SUCCESS => ') != -1 and
                    (ironic_database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: ironic_database.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['ironic-api'][0] }}"

- name: Reading json from variable
  set_fact:
    ironic_database_created: "{{ (ironic_database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"

- name: Creating Ironic database user and setting permissions
  command: docker exec -t kolla_toolbox /usr/bin/ansible localhost
    -m mysql_user
    -a "login_host='{{ database_address }}'
        login_port='{{ database_port }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ ironic_database_name }}'
        password='{{ ironic_database_password }}'
        host='%'
        priv='{{ ironic_database_name }}.*:ALL'
        append_privs='yes'"
  register: ironic_database_user_create
  changed_when: "{{ ironic_database_user_create.stdout.find('localhost | SUCCESS => ') != -1 and
                    (ironic_database_user_create.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: ironic_database_user_create.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['ironic-api'][0] }}"

- include: bootstrap_ironic_service.yml
  when: ironic_database_created

- name: Creating Ironic Inspector database
  command: docker exec -t kolla_toolbox /usr/bin/ansible localhost
    -m mysql_db
    -a "login_host='{{ database_address }}'
        login_port='{{ database_port }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ ironic_inspector_database_name }}'"
  register: ironic_inspector_database
  changed_when: "{{ ironic_inspector_database.stdout.find('localhost | SUCCESS => ') != -1 and
                    (ironic_inspector_database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: ironic_inspector_database.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['ironic-inspector'][0] }}"

- name: Reading json from variable
  set_fact:
    ironic_inspector_database_created: "{{ (ironic_inspector_database.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"

- name: Creating Ironic inspector database user and setting permissions
  command: docker exec -t kolla_toolbox /usr/bin/ansible localhost
    -m mysql_user
    -a "login_host='{{ database_address }}'
        login_port='{{ database_port }}'
        login_user='{{ database_user }}'
        login_password='{{ database_password }}'
        name='{{ ironic_inspector_database_name }}'
        password='{{ ironic_inspector_database_password }}'
        host='%'
        priv='{{ ironic_inspector_database_name }}.*:ALL'
        append_privs='yes'"
  register: inronic_inspector_database_user_create
  changed_when: "{{ inronic_inspector_database_user_create.stdout.find('localhost | SUCCESS => ') != -1 and
                    (inronic_inspector_database_user_create.stdout.split('localhost | SUCCESS => ')[1]|from_json).changed }}"
  failed_when: inronic_inspector_database_user_create.stdout.split()[2] != 'SUCCESS'
  run_once: True
  delegate_to: "{{ groups['ironic-inspector'][0] }}"

- include: bootstrap_inspector_service.yml
#when: ironic_inspector_database_created

- name: Running Ironic-PXE bootstrap container
  kolla_docker:
    action: "start_container"
    common_options: "{{ docker_common_options }}"
    detach: False
    environment:
      KOLLA_BOOTSTRAP:
      KOLLA_CONFIG_STRATEGY: "{{ config_strategy }}"
    image: "{{ ironic_pxe_image_full }}"
    labels:
      BOOTSTRAP:
    name: "bootstrap_ironic_pxe"
    restart_policy: "never"
    volumes:
      - "{{ node_config_directory }}/ironic-pxe/:{{ container_config_directory }}/:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - "ironic_pxe:/tftpboot/"
  run_once: True
  delegate_to: "{{ groups['ironic-pxe'][0] }}"
root@openstack2:/usr/local/share/kolla# ^C
root@openstack2:/usr/local/share/kolla# cat ./ansible/bootstrap_inspector_service.yml
---
- name: Running Ironic Inspector bootstrap container
  kolla_docker:
    action: "start_container"
    common_options: "{{ docker_common_options }}"
    detach: False
    environment:
      KOLLA_BOOTSTRAP:
      KOLLA_CONFIG_STRATEGY: "{{ config_strategy }}"
    image: "{{ ironic_inspector_image_full }}"
    labels:
      BOOTSTRAP:
    name: "bootstrap_ironic_inspector"
    restart_policy: "never"
    volumes:
      - "{{ node_config_directory }}/ironic-inspector/:{{ container_config_directory }}/:ro"
      - "/etc/localtime:/etc/localtime:ro"
  run_once: True
  delegate_to: "{{ groups['ironic-inspector'][0] }}"
